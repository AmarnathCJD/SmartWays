<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Smart Ways</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/js/all.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Material+Icons+Round" rel="stylesheet">
    <link href="assets/style.css" rel="stylesheet">
    <script src="/maps"></script>
</head>

<body>
    <nav class="navbar">
        <div class="logo">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10" />
                <line x1="12" y1="16" x2="12" y2="12" />
                <line x1="12" y1="8" x2="12" y2="8" />
            </svg>
            <span>Smart Ways</span>
        </div>
        <div class="search-container">
            <input id="search" type="text" placeholder="Search locations or routes..." autocomplete="off">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2">
                <circle cx="11" cy="11" r="8" />
                <line x1="21" y1="21" x2="16.65" y2="16.65" />
            </svg>
            <div class="search-suggestions"></div>
        </div>
        <div class="user-profile">
            <div class="user-avatar">SW</div>
            <div class="user-info">
                <div class="user-name"></div>
                <div class="user-role"></div>
            </div>
        </div>
    </nav>

    <div class="main-container">
        <div class="map-container">
            <div id="map"></div>
            <div class="control-panel">
                <script>
                    let shareLocation = true;
                </script>
                <button class="control-btn" data-tooltip="Stop sharing location"
                    onclick="shareLocation ? createNotification('Location sharing stopped', 'Your location is no longer being shared', 'info') : createNotification('Location sharing started', 'Your location is now being shared', 'info'); shareLocation = !shareLocation; document.getElementById('loc').textContent = shareLocation ? 'Stop' : 'Start';">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2">
                        <path d="M12 22s-8-4.5-8-11.8A8 8 0 0 1 12 2a8 8 0 0 1 8 8.2c0 7.3-8 11.8-8 11.8z" />
                        <circle cx="12" cy="10" r="3" />
                    </svg>
                    <span id="loc">Stop</span>
                </button>
                <button class="control-btn" data-tooltip="Find better routes">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2">
                        <polygon points="3 11 22 2 13 21 11 13 3 11" />
                    </svg>
                    <span>Routes</span>
                </button>
                <button class="control-btn" data-tooltip="Report an issue">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2">
                        <path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z" />
                        <line x1="4" y1="22" x2="4" y2="15" />
                    </svg>
                    <span>Report</span>
                </button>
            </div>
        </div>

        <div class="info-panel">
            <div class="info-section">
                <h2>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2">
                        <path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z" />
                    </svg>
                    Nearest Junction
                </h2>
                <div class="info-item" id="nearest-name">Fetching Nearest... (<span id="nearest-dist">...</span>)</div>
            </div>
            <div class="info-section">
                <h2>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2">
                        <path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z" />
                    </svg>
                    Junction Details
                </h2>
                <div class="info-item" id="jn-n">Central Junction</div>
                <div class="info-item" id="jn-d">2 mins away</div>
            </div>

            <div class="info-section">
                <h2>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2">
                        <circle cx="12" cy="12" r="10" />
                        <line x1="12" y1="16" x2="12" y2="12" />
                        <line x1="12" y1="8" x2="12" y2="8" />
                    </svg>
                    Traffic Status
                </h2>
                <div class="info-item flex gap-4 p-4 bg-gray-800 text-white rounded-lg shadow-lg">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-arrow-up text-green-400"></i>
                        <span id="vn"><i class="fas fa-loader fa-spin"></i></span>
                    </div>
                    <div class="flex items-center gap-2">
                        <i class="fas fa-arrow-down text-red-400"></i>
                        <span id="vs"><i class="fas fa-loader fa-spin"></i></span>
                    </div>
                    <div class="flex items-center gap-2">
                        <i class="fas fa-arrow-right text-blue-400"></i>
                        <span id="ve"><i class="fas fa-loader fa-spin"></i></span>
                    </div>
                    <div class="flex items-center gap-2">
                        <i class="fas fa-arrow-left text-yellow-400"></i>
                        <span id="vw"><i class="fas fa-loader fa-spin"></i></span>
                    </div>
                </div>
                <div class="info-item" style="display: flex; align-items: center; gap: 10px;">
                    <span class="status green"></span>
                    <span id="signal-1" style="flex: 1; text-align: left;">North: (45s)</span>
                </div>
                <div class="info-item" style="display: flex; align-items: center; gap: 10px;">
                    <span class="status red"></span>
                    <span id="signal-2" style="flex: 1; text-align: left;">South: (30s)</span>
                </div>
                <div class="info-item" style="display: flex; align-items: center; gap: 10px;">
                    <span class="status yellow"></span>
                    <span id="signal-3" style="flex: 1; text-align: left;">East: (5s)</span>
                </div>
                <div class="info-item" style="display: flex; align-items: center; gap: 10px;">
                    <span class="status red"></span>
                    <span id="signal-4" style="flex: 1; text-align: left;">West: (25s)</span>
                </div>

            </div>

            <div class="info-section" style="overflow-y: auto; max-height: 80px;">
                <h2>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2">
                        <polygon points="3 11 22 2 13 21 11 13 3 11" />
                    </svg>
                    Suggested Routes
                </h2>
                <div class="info-item" id="route">Route 1: Via Highway (Fastest)</div>
            </div>
        </div>
    </div>

    <div class="tooltip"></div>

    <script>
        const userName = `{{.Name}}`;
        const userRole = `{{.Type}}`;
        let userType = parseInt(userRole);

        document.querySelector('.user-name').textContent = userName;
        document.querySelector('.user-role').textContent = userRole == 3 ? 'User' : userRole == 2 ? 'Emergency Services' : 'Admin';

        let userPreferences = {
            notifications: {
                emergencyAlerts: true,
                trafficUpdates: true,
                maintenanceAlerts: false
            },
            routePreferences: {
                avoidTolls: false,
                preferHighways: true,
                avoidTraffic: true
            },
            mapPreferences: {
                darkMode: true,
                showTrafficLayers: true,
                showLandmarks: false
            }
        };

        const junctions = {
            "9.591596298490161,76.5221684495039": { name: "KOTTAYAM", id: 0 },
            "9.936758,76.318157": { name: "MARADU TRAFFIC JUNCTION", id: 1 },
            "9.968411,76.318126": { name: "VYTILLA TRAFFIC JUNCTION", id: 2 },
            "10.004741,76.312910": { name: "PIPLINE JUNCTION", id: 3 },
            "10.024530,76.308133": { name: "EDAPPALLY JUNCTION", id: 4 },
            "10.060798,76.288913": { name: "CHERANALLOOR SIGNAL", id: 5 },
            "10.061223,76.323173": { name: "NORTH KALAMASSERY SIGNAL", id: 6 },
            "10.11055260709765, 76.34893315112518": { name: "ALUVA", id: 7 },
            "9.99502182026216, 76.2920767170201": { name: "KALOOR JUNCTION", id: 8 },
            "9.988631396441125, 76.28596800755939": { name: "ERNAKULAM NORTH JUNCTION", id: 9 },
            "9.985781719379675, 76.2815624795593": { name: "BANERJI RD JUNCTION", id: 10 },
            "9.983773530935894, 76.27394860582694": { name: "HIGH COURT SIGNAL JUNCTION", id: 11 },
        };

        const controlPanel = document.querySelector('.control-panel');

        const settingsButton = document.createElement('button');
        settingsButton.className = 'control-btn';
        settingsButton.innerHTML = `
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="3"/>
        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
    </svg>
    <span>Settings</span>
`;
        settingsButton.setAttribute('data-tooltip', 'Open Settings');
        settingsButton.onclick = openSettings;
        controlPanel.appendChild(settingsButton);

        if (userType === 1) {
            const adminButton = document.createElement('button');
            adminButton.className = 'control-btn';
            adminButton.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 20h9M12 4h9M12 12h9M3 20h.01M3 4h.01M3 12h.01"/>
        </svg>
        <span>Manual Control</span>
    `;
            adminButton.setAttribute('data-tooltip', 'Toggle Manual Control');
            adminButton.onclick = function () {
                window.location.href = '/admin';
            };
            controlPanel.appendChild(adminButton);
        } else if (userType === 2) {
            const emergencyButton = document.createElement('button');
            emergencyButton.className = 'control-btn emergency';
            emergencyButton.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 22s-8-4.5-8-11.8A8 8 0 0 1 12 2a8 8 0 0 1 8 8.2c0 7.3-8 11.8-8 11.8z"/>
            <circle cx="12" cy="10" r="3"/>
        </svg>
        <span>Report Emergency</span>
    `;
            emergencyButton.setAttribute('data-tooltip', 'Report Emergency');
            emergencyButton.onclick = () => window.location.href = '/emergency';
            controlPanel.appendChild(emergencyButton);
        }

        const settingsModal = document.createElement('div');
        settingsModal.className = 'modal settings-modal';
        settingsModal.innerHTML = `
    <div class="modal-content" style="margin-bottom: 20px;">
        <div class="modal-header">
            <h2>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                </svg>
                Settings
            </h2>
            <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body settings-body">
            <div class="settings-section">
                <h3>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                        <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                    </svg>
                    Notifications
                </h3>
                <div class="setting-item">
                    <label class="toggle">
                        <input type="checkbox" id="emergencyAlerts" checked>
                        <span class="toggle-slider"></span>
                        Emergency Alerts
                    </label>
                </div>
                <div class="setting-item">
                    <label class="toggle">
                        <input type="checkbox" id="trafficUpdates" checked>
                        <span class="toggle-slider"></span>
                        Traffic Updates
                    </label>
                </div>
                <div class="setting-item">
                    <label class="toggle">
                        <input type="checkbox" id="maintenanceAlerts">
                        <span class="toggle-slider"></span>
                        Maintenance Alerts
                    </label>
                </div>
            </div>
            <div class="settings-section">
                <h3>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="3 11 22 2 13 21 11 13 3 11"/>
                    </svg>
                    Route Preferences
                </h3>
                <div class="setting-item">
                    <label class="toggle">
                        <input type="checkbox" id="avoidTolls">
                        <span class="toggle-slider"></span>
                        Avoid Toll Roads
                    </label>
                </div>
                <div class="setting-item">
                    <label class="toggle">
                        <input type="checkbox" id="preferHighways" checked>
                        <span class="toggle-slider"></span>
                        Prefer Highways
                    </label>
                </div>
                <div class="setting-item">
                    <label class="toggle">
                        <input type="checkbox" id="avoidTraffic" checked>
                        <span class="toggle-slider"></span>
                        Avoid Heavy Traffic
                    </label>
                </div>
            </div>
            <div class="settings-section">
                <h3>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
                        <path d="M2 12h20"/>
                    </svg>
                    Map Preferences
                </h3>
                <div class="setting-item">
                    <label class="toggle">
                        <input type="checkbox" id="darkMode" checked>
                        <span class="toggle-slider"></span>
                        Dark Mode
                    </label>
                </div>
                <div class="setting-item">
                    <label class="toggle">
                        <input type="checkbox" id="showTrafficLayers" checked>
                        <span class="toggle-slider"></span>
                        Show Traffic Layers
                    </label>
                </div>
                <div class="setting-item">
                    <label class="toggle">
                        <input type="checkbox" id="showLandmarks">
                        <span class="toggle-slider"></span>
                        Show Landmarks
                    </label>
                </div>
            </div>
        </div>
        <div class="modal-actions">
            <button class="control-btn cancel" onclick="settingsModal.style.display = 'none'">Cancel</button>
            <button class="control-btn save">Save Changes</button>
        </div>
    </div>
`;
        document.body.appendChild(settingsModal);

        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.innerHTML = `
    <div class="modal-content">
        <div class="modal-header">
            <h2>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="12" y1="16" x2="12" y2="12"/>
                    <line x1="12" y1="8" x2="12" y2="8"/>
                </svg>
                Manual Traffic Control
            </h2>
            <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <div class="junction-select">
                <select class="junction-dropdown">
                    ${Object.values(junctions).map(junction => `<option value="${junction.id}">${junction.name}</option>`).join('')}
                </select>
            </div>
            <div class="traffic-controls">
                <div class="direction-control">
                    <h3>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="19" x2="12" y2="5"/>
                            <polyline points="5 12 12 5 19 12"/>
                        </svg>
                        North
                    </h3>
                    <div class="color-controls">
                        <button class="color-btn red" data-color="red"></button>
                        <button class="color-btn green" data-color="green"></button>
                    </div>
                    <input type="number" class="timer-input" placeholder="Seconds" min="0" max="300">
                </div>
                <div class="direction-control">
                    <h3>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"/>
                            <polyline points="19 12 12 19 5 12"/>
                        </svg>
                        South
                    </h3>
                    <div class="color-controls">
                        <button class="color-btn red" data-color="red"></button>
                        <button class="color-btn green" data-color="green"></button>
                    </div>
                    <input type="number" class="timer-input" placeholder="Seconds" min="0" max="300">
                </div>
                <div class="direction-control">
                    <h3>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="5" y1="12" x2="19" y2="12"/>
                            <polyline points="12 5 19 12 12 19"/>
                        </svg>
                        East
                    </h3>
                    <div class="color-controls">
                        <button class="color-btn red" data-color="red"></button>
                        <button class="color-btn green" data-color="green"></button>
                    </div>
                    <input type="number" class="timer-input" placeholder="Seconds" min="0" max="300">
                </div>
                <div class="direction-control">
                    <h3>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="19" y1="12" x2="5" y2="12"/>
                            <polyline points="12 19 5 12 12 5"/>
                        </svg>
                        West
                    </h3>
                    <div class="color-controls">
                        <button class="color-btn red" data-color="red"></button>
                        <button class="color-btn green" data-color="green"></button>
                    </div>
                    <input type="number" class="timer-input" placeholder="Seconds" min="0" max="300">
                </div>
            </div>
            <div class="modal-actions">
                <button class="control-btn cancel" onclick="modal.style.display = 'none'">Cancel</button>
                <button class="control-btn enforce">Enforce Changes</button>
            </div>
        </div>
    </div>
`;
        document.body.appendChild(modal);

        function openSettings() {
            Object.entries(userPreferences.notifications).forEach(([key, value]) => {
                document.getElementById(key).checked = value;
            });
            Object.entries(userPreferences.routePreferences).forEach(([key, value]) => {
                document.getElementById(key).checked = value;
            });
            Object.entries(userPreferences.mapPreferences).forEach(([key, value]) => {
                document.getElementById(key).checked = value;
            });

            settingsModal.style.display = 'block';
        }

        settingsModal.querySelector('.save').onclick = function () {
            userPreferences = {
                notifications: {
                    emergencyAlerts: document.getElementById('emergencyAlerts').checked,
                    trafficUpdates: document.getElementById('trafficUpdates').checked,
                    maintenanceAlerts: document.getElementById('maintenanceAlerts').checked
                },
                routePreferences: {
                    avoidTolls: document.getElementById('avoidTolls').checked,
                    preferHighways: document.getElementById('preferHighways').checked,
                    avoidTraffic: document.getElementById('avoidTraffic').checked
                },
                mapPreferences: {
                    darkMode: document.getElementById('darkMode').checked,
                    showTrafficLayers: document.getElementById('showTrafficLayers').checked,
                    showLandmarks: document.getElementById('showLandmarks').checked
                }
            };

            applySettings();
            settingsModal.style.display = 'none';

            showNotification('Settings saved successfully');
        };

        function applySettings() {
            document.body.classList.toggle('light-mode', !userPreferences.mapPreferences.darkMode);

            if (window.map) {
                // map.setOptions({
                //     styles: userPreferences.mapPreferences.darkMode ? darkMapStyle : lightMapStyle
                // });
            }

            updateRoutePreferences();
        }

        function updateRoutePreferences() {
            const routesList = document.querySelectorAll('.info-section:last-child .info-item');
            if (userPreferences.routePreferences.avoidTolls) {
                routesList[0].textContent = 'Route 1: Via Local Roads (Toll-free)';
            } else {
                routesList[0].textContent = 'Route 1: Via Highway (Fastest)';
            }
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.classList.add('show');
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => notification.remove(), 300);
                }, 2000);
            }, 100);
        }

        function openManualControl() {
            modal.style.display = 'block';
        }

        [modal, settingsModal].forEach(modalElement => {
            modalElement.querySelector('.modal-close').onclick = () => modalElement.style.display = 'none';
            modalElement.onclick = (e) => {
                if (e.target === modalElement) modalElement.style.display = 'none';
            };
        });

        const colorButtons = modal.querySelectorAll('.color-btn');
        colorButtons.forEach(btn => {
            btn.onclick = function () {
                const controls = this.closest('.color-controls');
                controls.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
            };
        });

        modal.querySelector('.enforce').onclick = function () {
            const junction = modal.querySelector('.junction-dropdown').value;
            if (!junction) {
                showNotification('Please select a junction');
                return;
            }

            const changes = {};
            modal.querySelectorAll('.direction-control').forEach(control => {
                const direction = control.querySelector('h3').textContent.toLowerCase().trim();
                const selectedColor = control.querySelector('.color-btn.active');
                const timer = control.querySelector('.timer-input').value;

                if (selectedColor && timer) {
                    changes[direction] = {
                        color: selectedColor.dataset.color,
                        timer: parseInt(timer)
                    };
                }
            });

            if (Object.keys(changes).length === 0) {
                showNotification('Please set at least one signal');
                return;
            }

            Object.entries(changes).forEach(([direction, data]) => {
                const signalElement = document.querySelector(`#signal-${direction}`);
                if (signalElement) {
                    const statusElement = signalElement.previousElementSibling;
                    statusElement.className = `status ${data.color}`;
                    signalElement.textContent = `${direction.charAt(0).toUpperCase() + direction.slice(1)}: ${data.color.charAt(0).toUpperCase() + data.color.slice(1)} (${data.timer}s)`;
                }
            });

            showNotification('Traffic signals updated successfully');
            modal.style.display = 'none';
        };

        const style = document.createElement('style');
        style.textContent = `
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        backdrop-filter: blur(5px);
    }

    .modal-content {
        position: relative;
        background: var(--bg-card);
        margin: 1% auto;
        padding: 20px;
        width: 90%;
        max-width: 600px;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        animation: modalSlideIn 0.3s ease-out;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .modal-header h2 {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 1.2rem;
        color: var(--primary);
    }

    .modal-header h2 svg {
        width: 20px;
        height: 20px;
    }

    .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        color: var(--text-primary);
        cursor: pointer;
        padding: 5px;
        transition: color 0.3s ease;
    }

    .modal-close:hover {
        color: var(--primary);
    }

    .junction-select {
        margin-bottom: 20px;
    }

    .junction-dropdown {
        width: 100%;
        padding: 12px;
        background: var(--bg-elevated);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        color: var(--text-primary);
        font-size: 0.9rem;
        transition: all 0.3s ease;
    }

    .junction-dropdown:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 2px rgba(255, 51, 51, 0.2);
    }

    .traffic-controls {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
        margin-bottom: 20px;
    }

    .direction-control {
        background: var(--bg-elevated);
        padding: 15px;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .direction-control:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .direction-control h3 {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 1rem;
        margin-bottom: 12px;
        color: var(--text-primary);
    }

    .direction-control h3 svg {
        width: 16px;
        height: 16px;
        stroke: var(--primary);
    }

    .color-controls {
        display: flex;
        gap: 10px;
        margin: 10px 0;
    }

    .color-btn {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        border: 2px solid rgba(255, 255, 255, 0.1);
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
    }

    .color-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
    }

    .color-btn.active {
        border-color: var(--primary);
        box-shadow: 0 0 0 2px rgba(255, 51, 51, 0.2);
    }

    .color-btn.active::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 10px;
        height: 10px;
        background: white;
        border-radius: 50%;
        animation: pulse 2s infinite;
    }

    .color-btn.red { background: #f44336; }
    .color-btn.green { background: #4CAF50; }

    .timer-input {
        width: 100%;
        padding: 10px;
        background: var(--bg-elevated);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 6px;
        color: var(--text-primary);
        font-size: 0.9rem;
        transition: all 0.3s ease;
    }

    .timer-input:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 2px rgba(255, 51, 51, 0.2);
    }

    .modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .control-btn.emergency {
        background: #f44336;
    }

    .control-btn.emergency:hover {
        background: #d32f2f;
    }

    .control-btn.save {
        background: var(--primary);
    }

    .control-btn.save:hover {
        background: var(--primary-hover);
    }

    /* Settings specific styles */
    .settings-body {
        max-height: 70vh;
        overflow-y: auto;
        padding-right: 10px;
    }

    .settings-section {
        background: var(--bg-elevated);
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .settings-section h3 {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 1rem;
        margin-bottom: 15px;
        color: var(--primary);
    }

    .settings-section h3 svg {
        width: 16px;
        height: 16px;
    }

    .setting-item {
        margin-bottom: 10px;
    }

    .toggle {
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
        user-select: none;
        color: var(--text-primary);
        font-size: 0.9rem;
    }

    .toggle input {
        display: none;
    }

    .toggle-slider {
        position: relative;
        width: 40px;
        height: 20px;
        background: var(--bg-dark);
        border-radius: 20px;
        transition: all 0.3s ease;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .toggle-slider::before {
        content: '';
        position: absolute;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: var(--text-secondary);
        top: 1px;
        left: 2px;
        transition: all 0.3s ease;
    }

    .toggle input:checked + .toggle-slider {
        background: var(--primary);
    }

    .toggle input:checked + .toggle-slider::before {
        transform: translateX(19px);
        background: white;
    }

    .notification {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: var(--primary);
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        transform: translateY(100px);
        opacity: 0;
        transition: all 0.3s ease;
        z-index: 2000;
    }

    .notification.show {
        transform: translateY(0);
        opacity: 1;
    }

    @keyframes pulse {
        0% {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
        }
        100% {
            transform: translate(-50%, -50%) scale(2);
            opacity: 0;
        }
    }

    @keyframes modalSlideIn {
        from {
            transform: translateY(-10%);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    @media (max-width: 768px) {
        .traffic-controls {
            grid-template-columns: 1fr;
        }
        
        .modal-content {
            margin: 10% auto;
            width: 95%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .settings-body {
            max-height: 60vh;
        }
    }
}
`;
        document.head.appendChild(style);

        const signalTimes = [45, 30, 5, 25];
        const signals = document.querySelectorAll('.info-item span[id^="signal-"]');
        signals.forEach((signal, index) => {
            signal.textContent = signal.textContent.replace(/\d+s/, `${signalTimes[index]}s`);
        });

        const signalColors = document.querySelectorAll('.status');
        let activeJunction = 1;

        setInterval(() => {
            if (activeJunction === 0) {
                return;
            }
            signalTimes.forEach((time, index) => {
                if (time === 0) {
                    signalTimes[index] = index % 3 === 0 ? 45 : 30;
                } else {
                    signalTimes[index]--;
                }
            });

            signals.forEach((signal, index) => {
                signal.textContent = signal.textContent.replace(/\d+s/, `${signalTimes[index]}s`);
            });

            signalColors.forEach((signal, index) => {
                if (signalTimes[index] > 30) {
                    signal.className = 'status green';
                } else if (signalTimes[index] > 10) {
                    signal.className = 'status red';
                } else {
                    signal.className = 'status yellow';
                }
            });
        }, 1000);

        const searchInput = document.querySelector('#search');
        const searchSuggestions = document.querySelector('.search-suggestions');

        const JunctionNames = Object.values(junctions).map(junction => junction.name);

        function showSuggestions(input) {
            const value = input.toLowerCase();
            if (!value) {
                searchSuggestions.style.display = 'none';
                return;
            }

            const filteredSuggestions = JunctionNames.filter(junction =>
                junction.toLowerCase().includes(value)
            );

            if (filteredSuggestions.length === 0) {
                searchSuggestions.style.display = 'none';
                return;
            }

            searchSuggestions.innerHTML = filteredSuggestions
                .map(suggestion => `
            <div class="suggestion-item">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"/>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                </svg>
                ${suggestion}
            </div>
        `)
                .join('');

            searchSuggestions.style.display = 'block';
        }

        searchInput.addEventListener('input', (e) => showSuggestions(e.target.value));
        searchInput.addEventListener('focus', () => {
            if (searchInput.value) {
                showSuggestions(searchInput.value);
            }
        });

        document.addEventListener('click', (e) => {
            if (!searchInput.contains(e.target) && !searchSuggestions.contains(e.target)) {
                searchSuggestions.style.display = 'none';
            }
        });

        function initMap() {
            let loc = { lat: 9.9312, lng: 76.2673 };
            const map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: -34.397, lng: 150.644 },
                zoom: 14,
                disableDefaultUI: true,
                fullscreenControl: true,
                styles: [
                    { elementType: "geometry", stylers: [{ color: "#242f3e" }] },
                    { elementType: "labels.text.stroke", stylers: [{ color: "#242f3e" }] },
                    { elementType: "labels.text.fill", stylers: [{ color: "#746855" }] },
                    {
                        featureType: "administrative.locality",
                        elementType: "labels.text.fill",
                        stylers: [{ color: "#d59563" }],
                    },
                    {
                        featureType: "road",
                        elementType: "geometry",
                        stylers: [{ color: "#38414e" }],
                    },
                    {
                        featureType: "road",
                        elementType: "geometry.stroke",
                        stylers: [{ color: "#212a37" }],
                    },
                    {
                        featureType: "road",
                        elementType: "labels.text.fill",
                        stylers: [{ color: "#9ca5b3" }],
                    },
                    {
                        featureType: "water",
                        elementType: "geometry",
                        stylers: [{ color: "#17263c" }],
                    }
                ],
            });

            let mk = [];

            map.addListener("click", (event) => {
                const m = new google.maps.Marker({
                    position: event.latLng,
                    map: map,
                    icon: {
                        "url": "https://img.icons8.com/external-flaticons-flat-flat-icons/64/external-destination-map-and-navigation-flaticons-flat-flat-icons-3.png",
                        "scale": 1,
                        "fillColor": "#ff3333",
                        "fillOpacity": 1,
                    },
                });

                const lat = event.latLng.lat();
                const lng = event.latLng.lng();

                const nearestJunction = Object.keys(junctions).reduce((nearest, junction) => {
                    const distance = Math.sqrt(Math.pow(lat - parseFloat(junction.split(",")[0]), 2) + Math.pow(lng - parseFloat(junction.split(",")[1]), 2));
                    return distance < nearest.distance ? { distance, ...junction } : nearest;
                });

                const distance = calc_distance(lat, lng, { lat: parseFloat(nearestJunction.split(",")[0]), lng: parseFloat(nearestJunction.split(",")[1]) });
                document.getElementById('nearest-name').textContent = junctions[nearestJunction].name + " ---> (" + distance.toFixed(2) + " km)";

                // show directorions to it and make junctions passing throgh to color red
                const directionsService = new google.maps.DirectionsService();
                const directionsRenderer = new google.maps.DirectionsRenderer({ suppressMarkers: true });
                directionsRenderer.setMap(map);
                let rt = directionsService.route(
                    {
                        origin: { location: loc },
                        destination: {
                            lat: lat,
                            lng: lng,
                        },
                        travelMode: google.maps.TravelMode.DRIVING,
                        provideRouteAlternatives: true,
                        drivingOptions: {
                            departureTime: new Date(),
                            trafficModel: 'pessimistic'
                        },
                    },
                    (response, status) => {
                        if (status === "OK") {
                            directionsRenderer.setDirections(response);
                        } else {
                            console.log("Directions request failed due to " + status);
                        }
                    }
                );

                function randomInt(min, max) {
                    return Math.floor(Math.random() * (max - min + 1) + min);
                }

                rt.then((result) => {
                    const routesList = document.querySelector('.info-section:last-child');
                    showNotification('Route calculated successfully');
                    for (let i = 0; i < result.routes.length; i++) {
                        const decodedPath = google.maps.geometry.encoding.decodePath(result.routes[i].overview_polyline);
                        let doneJns = [];
                        decodedPath.forEach((path) => {
                            // iter through junctions and check if path is near to any junction
                            Object.keys(junctions).forEach((junction) => {
                                const distance = calc_distance(path.lat(), path.lng(), { lat: parseFloat(junction.split(",")[0]), lng: parseFloat(junction.split(",")[1]) });
                                if (doneJns.includes(junction)) {
                                    return;
                                }
                                if (distance < 0.5) {
                                    doneJns.push(junction);
                                    // get that jn from mk, delete it and insert a new one with red color
                                    mk.forEach((m) => {
                                        if (m.getPosition().lat() === parseFloat(junction.split(",")[0]) && m.getPosition().lng() === parseFloat(junction.split(",")[1])) {
                                            m.setMap(null);
                                            const mx = new google.maps.Marker({
                                                position: { lat: parseFloat(junction.split(",")[0]), lng: parseFloat(junction.split(",")[1]) },
                                                map: map,
                                                icon: {
                                                    "url": "https://img.icons8.com/external-flatart-icons-lineal-color-flatarticons/64/external-directions-tourism-and-outdoor-recreation-flatart-icons-lineal-color-flatarticons-1.png",
                                                    "scale": 0.4,
                                                    "fillColor": "#ff0000",
                                                    "fillOpacity": 1,
                                                },
                                            });
                                            const infoWindowStyle = `
        <div class="custom-info-window">
            <style>
                .custom-info-window {
                    background: rgba(26, 26, 26, 0.98);
                    color: #ffffff;
                    padding: 12px 16px;
                    border-radius: 8px;
                    font-family: 'Inter', sans-serif;
                    font-size: 14px;
                    border: 1px solid rgba(255, 255, 255, 0.05);
                    backdrop-filter: blur(10px);
                    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
                }
                .gm-style .gm-style-iw-c {
                    background: transparent !important;
                    box-shadow: none !important;
                    padding: 0 !important;
                    border-radius: 8px !important;
                }
                .gm-style .gm-style-iw-d {
                    overflow: hidden !important;
                    background: transparent !important;
                }
                .gm-style .gm-style-iw-t::after {
                    display: none !important;
                }
                .gm-ui-hover-effect {
                    background: rgba(26, 26, 26, 0.98) !important;
                    border-radius: 50% !important;
                    top: 4px !important;
                    right: 4px !important;
                    width: 24px !important; /* Increased size */
                    height: 24px !important;
                    display: flex !important;
                    align-items: center !important;
                    justify-content: center !important;
                }
                .gm-ui-hover-effect img {
                    filter: invert(1) !important; /* Makes the close button white */
                    opacity: 0.9 !important;
                    width: 12px !important; /* Slightly larger */
                    height: 12px !important;
                }
                .gm-ui-hover-effect:hover img {
                    opacity: 1 !important;
                }
            </style>
            <div>${junctions[junction].name}</div>
            <div>${calc_distance(loc.lat, loc.lng, { lat: parseFloat(junction.split(",")[0]), lng: parseFloat(junction.split(",")[1]) }).toFixed(2)} km away</div>
            <br>
            <div>Vehicle Count: ${randomInt(10, 100)}</div>
            <br>
            <div class="info-item" style="display: flex; align-items: center; gap: 10px;">
                    <span class="status green"></span>
                    <span id="signal-1" style="flex: 1; text-align: left;">North: (45s)</span>
                </div>
                <div class="info-item" style="display: flex; align-items: center; gap: 10px;">
                    <span class="status red"></span>
                    <span id="signal-2" style="flex: 1; text-align: left;">South: (30s)</span>
                </div>
                <div class="info-item" style="display: flex; align-items: center; gap: 10px;">
                    <span class="status yellow"></span>
                    <span id="signal-3" style="flex: 1; text-align: left;">East: (5s)</span>
                </div>
                <div class="info-item" style="display: flex; align-items: center; gap: 10px;">
                    <span class="status red"></span>
                    <span id="signal-4" style="flex: 1; text-align: left;">West: (25s)</span>
                </div>
        </div>
    `;
                                            const infowindow = new google.maps.InfoWindow({
                                                content: infoWindowStyle,
                                                position: { lat: parseFloat(junction.split(",")[0]), lng: parseFloat(junction.split(",")[1]) },
                                                pixelOffset: new google.maps.Size(0, -30),
                                            });

                                            popus.push(infowindow);

                                            mx.addListener("click", () => {
                                                popus.forEach((pop) => {
                                                    pop.close();
                                                });
                                                infowindow.open(map, mx);

                                                map.panTo(mx.getPosition());
                                                fetch(`/api/jn?jid=${junctions[junction].id}`)
                                                    .then((res) => res.json())
                                                    .then((data) => {
                                                        document.getElementById('jn-n').textContent = junctions[junction].name;
                                                        const lat = parseFloat(junction.split(",")[0]);
                                                        const lng = parseFloat(junction.split(",")[1]);
                                                        document.getElementById('jn-d').textContent = calc_distance(lat, lng, loc).toFixed(2) + " km";
                                                        document.getElementById('vn').textContent = data.vehicles.north;
                                                        document.getElementById('vs').textContent = data.vehicles.south;
                                                        document.getElementById('ve').textContent = data.vehicles.east;
                                                        document.getElementById('vw').textContent = data.vehicles.west;
                                                    })
                                            });


                                            mk.push(mx);
                                            return;
                                        }
                                    });

                                }
                            });
                        });
                        const route = result.routes[i];
                        const routeItem = document.createElement('div');
                        routeItem.className = 'info-item';
                        routeItem.textContent = `Route ${i + 1}: ${route.summary}`;
                        routesList.appendChild(routeItem);

                        routeItem.onclick = () => {
                            directionsRenderer.setRouteIndex(i);
                        };
                    }

                    updateRoutePreferences();
                });
            });


            function calc_distance(lat, lng, p2) {
                const radius = 6371e3;
                const lat1 = lat * Math.PI / 180;
                const lat2 = p2.lat * Math.PI / 180;
                const delta_lat = (p2.lat - lat) * Math.PI / 180;
                const delta_lng = (p2.lng - lng) * Math.PI / 180;

                const a = Math.sin(delta_lat / 2) * Math.sin(delta_lat / 2) +
                    Math.cos(lat1) * Math.cos(lat2) *
                    Math.sin(delta_lng / 2) * Math.sin(delta_lng / 2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

                return radius * c / 1000;
            }

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const pos = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                        };
                        loc = pos;
                        map.setCenter(pos);
                        new google.maps.Marker({
                            position: pos,
                            map: map,
                            icon: {
                                path: google.maps.SymbolPath.CIRCLE,
                                scale: 10,
                                fillColor: "#ff3333",
                                fillOpacity: 1,
                                strokeWeight: 2,
                                strokeColor: "#ffffff",
                            },
                        });

                        const nearestJunction = Object.keys(junctions).reduce((nearest, junction) => {
                            const distance = Math.sqrt(Math.pow(pos.lat - parseFloat(junction.split(",")[0]), 2) + Math.pow(pos.lng - parseFloat(junction.split(",")[1]), 2));
                            return distance < nearest.distance ? { distance, ...junction } : nearest;
                        });

                        const distance = calc_distance(pos.lat, pos.lng, { lat: parseFloat(nearestJunction.split(",")[0]), lng: parseFloat(nearestJunction.split(",")[1]) });
                        document.getElementById('nearest-name').textContent = junctions[nearestJunction].name + " ---> (" + distance.toFixed(2) + " km)";

                        document.getElementById('route').onclick = () => {
                            const directionsService = new google.maps.DirectionsService();
                            const directionsRenderer = new google.maps.DirectionsRenderer({ suppressMarkers: true });
                            directionsRenderer.setMap(map);

                            // find jn using activeJunction
                            const jn = Object.keys(junctions).find(key => junctions[key].id === activeJunction);

                            let rt = directionsService.route(
                                {
                                    origin: pos,
                                    destination: {
                                        lat: parseFloat(jn.split(",")[0]),
                                        lng: parseFloat(jn.split(",")[1]),
                                    },
                                    travelMode: google.maps.TravelMode.DRIVING,
                                    provideRouteAlternatives: true,
                                    drivingOptions: {
                                        departureTime: new Date(),
                                        trafficModel: 'pessimistic'
                                    },
                                },
                                (response, status) => {
                                    if (status === "OK") {
                                        directionsRenderer.setDirections(response);
                                    } else {
                                        console.log("Directions request failed due to " + status);
                                    }
                                }
                            );

                            rt.then((result) => {
                                const routesList = document.querySelector('.info-section:last-child');
                                showNotification('Route calculated successfully');
                                for (let i = 0; i < result.routes.length; i++) {
                                    const route = result.routes[i];
                                    const routeItem = document.createElement('div');
                                    routeItem.className = 'info-item';
                                    routeItem.textContent = `Route ${i + 1}: ${route.summary}`;
                                    routesList.appendChild(routeItem);

                                    routeItem.onclick = () => {
                                        directionsRenderer.setRouteIndex(i);
                                    };
                                }

                                updateRoutePreferences();
                            });
                        }
                    },

                    () => {
                        console.log("Error: The Geolocation service failed.");
                        document.getElementById('nearest-name').textContent = "Error: The Geolocation service failed.";
                    }
                );
            }

            window.map = map;

            const junctions = {
                "9.591596298490161,76.5221684495039": { name: "KOTTAYAM JUNCTION", id: 0 },
                "9.936758,76.318157": { name: "MARADU TRAFFIC JUNCTION", id: 1 },
                "9.968411,76.318126": { name: "VYTILLA TRAFFIC JUNCTION", id: 2 },
                "10.004741,76.312910": { name: "PIPLINE JUNCTION", id: 3 },
                "10.024530,76.308133": { name: "EDAPPALLY JUNCTION", id: 4 },
                "10.060798,76.288913": { name: "CHERANALLOOR SIGNAL", id: 5 },
                "10.061223,76.323173": { name: "NORTH KALAMASSERY SIGNAL", id: 6 },
                "10.11055260709765, 76.34893315112518": { name: "ALUVA", id: 7 },
                "9.99502182026216, 76.2920767170201": { name: "KALOOR JUNCTION", id: 8 },
                "9.988631396441125, 76.28596800755939": { name: "ERNAKULAM NORTH JUNCTION", id: 9 },
                "9.985781719379675, 76.2815624795593": { name: "BANERJI RD JUNCTION", id: 10 },
                "9.983773530935894, 76.27394860582694": { name: "HIGH COURT SIGNAL JUNCTION", id: 11 },
                "9.564680546605889, 76.75485493747884": { name: "PONKUNNAM JUNCTION", id: 12 },
                "9.382882887925652, 76.57505573122342": { name: "THIRUVALLA JUNCTION", id: 13 },
            };

            let popus = [];

            const markers = Object.keys(junctions).map((key) => {
                const marker = new google.maps.Marker({
                    position: {
                        lat: parseFloat(key.split(",")[0]),
                        lng: parseFloat(key.split(",")[1]),
                    },
                    map,
                    title: junctions[key].name,
                    icon: {
                        url: "https://envs.sh/QFs.png",
                        scaledSize: new google.maps.Size(48, 48),
                    },
                });

                mk.push(marker);

                const infoWindowStyle = `
        <div class="custom-info-window">
            <style>
                .custom-info-window {
                    background: rgba(26, 26, 26, 0.98);
                    color: #ffffff;
                    padding: 12px 16px;
                    border-radius: 8px;
                    font-family: 'Inter', sans-serif;
                    font-size: 14px;
                    border: 1px solid rgba(255, 255, 255, 0.05);
                    backdrop-filter: blur(10px);
                    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
                }
                .gm-style .gm-style-iw-c {
                    background: transparent !important;
                    box-shadow: none !important;
                    padding: 0 !important;
                    border-radius: 8px !important;
                }
                .gm-style .gm-style-iw-d {
                    overflow: hidden !important;
                    background: transparent !important;
                }
                .gm-style .gm-style-iw-t::after {
                    display: none !important;
                }
                .gm-ui-hover-effect {
                    background: rgba(26, 26, 26, 0.98) !important;
                    border-radius: 50% !important;
                    top: 4px !important;
                    right: 4px !important;
                    width: 24px !important; /* Increased size */
                    height: 24px !important;
                    display: flex !important;
                    align-items: center !important;
                    justify-content: center !important;
                }
                .gm-ui-hover-effect img {
                    filter: invert(1) !important; /* Makes the close button white */
                    opacity: 0.9 !important;
                    width: 12px !important; /* Slightly larger */
                    height: 12px !important;
                }
                .gm-ui-hover-effect:hover img {
                    opacity: 1 !important;
                }
            </style>
            <div>${junctions[key].name}</div>
        </div>
    `;

                const infowindow = new google.maps.InfoWindow({
                    content: infoWindowStyle,
                    maxWidth: 300,
                    pixelOffset: new google.maps.Size(0, -10)
                });

                popus.push(infowindow);

                marker.addListener("click", () => {
                    infowindow.open(map, marker);
                    for (let i = 0; i < popus.length; i++) {
                        if (popus[i] != infowindow) {
                            popus[i].close();
                        }
                    }
                    activeJunction = junctions[key].id;
                    signalColors.forEach((signal, index) => {
                        signal.className = "status red";
                    });

                    signals.forEach((signal, index) => {
                        signal.textContent = signal.textContent.replace(/\d+s/, `0s`);
                    });

                    map.panTo(marker.getPosition());
                    fetch(`/api/jn?jid=${junctions[key].id}`)
                        .then((res) => res.json())
                        .then((data) => {
                            document.getElementById('jn-n').textContent = junctions[key].name;
                            const lat = parseFloat(key.split(",")[0]);
                            const lng = parseFloat(key.split(",")[1]);
                            document.getElementById('jn-d').textContent = calc_distance(lat, lng, loc).toFixed(2) + " km";
                            document.getElementById('vn').textContent = data.vehicles.north;
                            document.getElementById('vs').textContent = data.vehicles.south;
                            document.getElementById('ve').textContent = data.vehicles.east;
                            document.getElementById('vw').textContent = data.vehicles.west;
                        })
                });

                return marker;
            });


            searchSuggestions.addEventListener('click', (e) => {
                const suggestionItem = e.target.closest('.suggestion-item');
                if (suggestionItem) {
                    searchInput.value = suggestionItem.textContent.trim();
                    searchSuggestions.style.display = 'none';

                    const junction = Object.values(junctions).find(junction => junction.name === searchInput.value);
                    if (junction) {
                        const latLng = Object.keys(junctions).find(key => junctions[key].name === searchInput.value);
                        const [lat, lng] = latLng.split(',').map(parseFloat);
                        map.panTo({ lat, lng });
                    }
                }
            });

            const trafficLayer = new google.maps.TrafficLayer();
            trafficLayer.setMap(map);
        }

        window.onload = initMap;

        function lightUpdater() {
            let url = `ws://${window.location.host}/ws`;
            if (window.location.protocol === "https:") {
                url = `wss://${window.location.host}/ws`;
            }

            const socket = new WebSocket(url);
            socket.onmessage = (event) => {
                let data;
                try {
                    data = JSON.parse(event.data);
                } catch (error) {
                    console.error('Invalid JSON data received', event.data);
                    return;
                }

                if (activeJunction !== 0 && data.type !== 'alert') {
                    return;
                }

                if (data.type === 'vehicleUpdate') {
                    manip(data.direction[0], "inc");
                } else if (data.type === 'lightChange') {
                    let directionIndex = { north: 0, south: 1, east: 2, west: 3 };
                    let index = directionIndex[data.direction];

                    if (index !== undefined) {
                        if (data.color === "red" && signalColors[index].className === "status green") {
                            manip(data.direction[0], "dec", 10);
                        }
                        signalColors[index].className = "status " + data.color;
                        signalTimes[index] = data.timeEffective || 0;
                        updateSignalText(index);
                    }
                } else if (data.type === 'alert') {
                    let content = '';
                    let severity = 'info';
                    if (data.color === 'ambulance') {
                        content = 'An ambulance is approaching your location. Please make way, and be prepared for delays.';
                        severity = 'warning';
                    } else if (data.color === 'fire') {
                        content = 'A firetruck is approaching your location. Nearby Fires have been reported. Please be cautious.';
                        severity = 'error';
                    } else {
                        content = 'Police and Emergency Services are on their way to your location. Please be cautious.';
                        severity = 'warning';
                    }

                    content += ' ( Destination: ' + data.direction + ' )';
                    createNotification("Caution: New Alert", content, severity, 15000);
                }
            };
        }

        function manip(dir, op, step = 1) {
            let elem = document.getElementById('v' + dir);
            if (!elem) return;

            let curr = parseInt(elem.textContent) || 0;
            let newVal = op === "inc" ? curr + step : Math.max(curr - step, 0);
            elem.textContent = newVal;
        }

        function updateSignalText(index) {
            let signal = signals[index];

            if (!signal) return;

            signal.textContent = signal.textContent.replace(/\d+s/, `${signalTimes[index]}s`);

            if (signalColors[index].className !== "status green" || signalTimes[index] <= 0) return;

            let update = setInterval(() => {
                if (signalTimes[index] <= 0) {
                    clearInterval(update);
                    signal.textContent = signal.textContent.replace(/\d+s/, `0s`);
                    return;
                }
                signalTimes[index]--;
                signal.textContent = signal.textContent.replace(/\d+s/, `${signalTimes[index]}s`);
            }, 1000);
        }

        lightUpdater();

        function createNotification(title, content, severity = 'info', duration = 5000) {
            const notification = document.createElement('div');
            notification.className = `toast-notification toast-notification-${severity} toast-notification-slide-in`;

            notification.innerHTML = `
    <div class="toast-notification-content">
      <span class="material-icons-round toast-notification-icon">
        ${getIconForSeverity(severity)}
      </span>
      <div class="toast-notification-text">
        <div class="toast-notification-title">${title}</div>
        <div class="toast-notification-message">${content}</div>
      </div>
      <button class="toast-notification-close">
        <span class="material-icons-round">close</span>
      </button>
    </div>
    <div class="toast-notification-progress"></div>
  `;

            const container = document.querySelector('.toast-notification-container') || (() => {
                const cont = document.createElement('div');
                cont.className = 'toast-notification-container';
                document.body.appendChild(cont);
                return cont;
            })();

            container.appendChild(notification);
            const progress = notification.querySelector('.toast-notification-progress');
            progress.style.animation = `progress ${duration}ms linear`;

            const closeBtn = notification.querySelector('.toast-notification-close');
            closeBtn.addEventListener('click', () => {
                notification.classList.add('toast-notification-slide-out');
                setTimeout(() => notification.remove(), 300);
            });

            if (duration) {
                setTimeout(() => {
                    notification.classList.add('toast-notification-slide-out');
                    setTimeout(() => notification.remove(), 300);
                }, duration);
            }
        }

        function getIconForSeverity(severity) {
            const icons = {
                success: 'check_circle',
                error: 'error',
                warning: 'warning',
                info: 'info'
            };
            return icons[severity] || 'info';
        }
    </script>
</body>

</html>